name: Build JUCE Plugin

env:
  project_name: CometChannelStrip

on:
  push:
    branches:
      - main

jobs:
  build-mac:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew install cmake gtk+3

      - name: Set Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.4.app

      - name: Clear CMake build directories
        run: |
          if [ -d Build ]; then
            rm -rf Build
          fi

      - name: Configure CMake
        run: cmake -B Build -D CMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"

      - name: Build
        run: cmake --build Build --config Release

      - name: Create Installer Mac AU
        run: |
          pkgbuild --root Build/${{ env.project_name }}_artefacts/Release/AU \
          --identifier com.ViatorDSP.${{ env.project_name }} \
          --install-location Library/Audio/Plug-Ins/Components \
          --version "1.0.0" \
          ${{ env.project_name }}-AU.pkg

      - name: Create Installer Mac VST3
        run: |
          pkgbuild --root Build/${{ env.project_name }}_artefacts/Release/VST3 \
          --identifier com.ViatorDSP.${{ env.project_name }} \
          --install-location Library/Audio/Plug-Ins/VST3 \
          --version "1.0.0" \
          ${{ env.project_name }}-VST3.pkg

      - name: Upload AU Installer
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.project_name }}-Mac-Installer-AU
          path: ${{ env.project_name }}-AU.pkg

      - name: Upload VST3 Installer
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.project_name }}-Mac-Installer-VST3
          path: ${{ env.project_name }}-VST3.pkg